/* Basic Reset */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #181a1b;
  color: #f3f3f3;
  line-height: 1.6;
  min-height: 100vh;
}

.topbar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #23272a;
  padding: 1rem 2rem;
  position: sticky;
  top: 0;
  z-index: 10;
}

.brand__name {
  font-size: 1.5rem;
  font-weight: bold;
}

.brand__tag {
  font-size: 0.9rem;
  color: #b9bbbe;
}

.sectionNav {
  display: flex;
  justify-content: center;
  gap: 1.5rem;
  background: #202225;
  padding: 0.5rem 0;
}

.sectionNav__link {
  color: #f3f3f3;
  text-decoration: none;
  padding: 0.5rem 1rem;
  border-radius: 4px;
  transition: background 0.2s;
}

.sectionNav__link.active,
.sectionNav__link:hover {
  background: #5865f2;
  color: #fff;
}

.snapRoot {
  scroll-snap-type: y mandatory;
  overflow-y: auto;
  height: 100vh;
}

.snapSection {
  scroll-snap-align: start;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
  background: var(--bgA, #23272a);
  transition: background-image 0.7s;
  position: relative;
}

.snapSection.swapBg {
  background-image: var(--bgB, none);
}

.panel {
  max-width: 800px;
  margin: 0 auto;
  background: rgba(32,34,37,0.95);
  padding: 2rem;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.3);
}

.chips, .tags {
  display: flex;
  gap: 0.5rem;
  margin: 1rem 0;
}

.chip, .tag {
  background: #5865f2;
  color: #fff;
  padding: 0.3rem 0.8rem;
  border-radius: 999px;
  font-size: 0.9rem;
}

.btn {
  background: #5865f2;
  color: #fff;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  cursor: pointer;
  font-size: 1rem;
  margin-right: 0.5rem;
  transition: background 0.2s;
  text-decoration: none;
}

.btn--ghost {
  background: transparent;
  color: #5865f2;
  border: 1px solid #5865f2;
}

.vol {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.vol__slider {
  width: 80px;
}

.grid3, .projectsGrid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 1.5rem;
  margin: 2rem 0;
  align-items: stretch; /* Make all cards same height */
}

.grid2 {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1.5rem;
  margin: 2rem 0;
}

.card, .projectCard, .eduCard, .contactCard {
  background: #23272a;
  padding: 1.2rem;
  border-radius: 8px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.2);
}

.projectCard__head {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.actions {
  margin-top: 1rem;
}

.link {
  color: #5865f2;
  text-decoration: underline;
  margin-right: 1rem;
}

.scrollCue, .scrollArrowOnly {
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  margin: 2rem auto 0 auto;
  font-size: 2rem;
  color: #5865f2;
  transition: color 0.2s;
}

.scrollCue__text {
  font-size: 1rem;
  color: #b9bbbe;
}

.scrollCue__arrow, .scrollArrowOnly {
  font-size: 2.5rem;
}

.muted {
  color: #b9bbbe;
}

.tiny {
  font-size: 0.8rem;
}

.easterEgg {
  position: fixed;
  bottom: 24px;
  right: 24px;
  width: 32px;
  height: 32px;
  background: #5865f2;
  border-radius: 50%;
  border: none;
  z-index: 100;
  opacity: 0.7;
  cursor: pointer;
  /* Hide the easter egg button but keep it accessible */
  opacity: 0;
  pointer-events: auto;
  outline: none;
  background: transparent;
  border: none;
  width: 32px;
  height: 32px;
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 100;
  /* Optional: add a focus style for keyboard users */
}

.easterEgg:focus {
  opacity: 0.2;
  outline: 2px solid #5865f2;
}

.modal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.7);
  z-index: 200;
  justify-content: center;
  align-items: center;
}

.modal.open {
  display: flex;
}

.modal__content {
  background: #23272a;
  padding: 2rem;
  border-radius: 12px;
  position: relative;
  max-width: 600px;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
}

.modal__close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: #5865f2;
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  font-size: 1.2rem;
  cursor: pointer;
}

.ssVideo {
  width: 100%;
  max-width: 480px;
  border-radius: 8px;
  margin-bottom: 1rem;
}

@media (max-width: 900px) {
  .grid3, .projectsGrid {
    grid-template-columns: 1fr;
  }
  .grid2 {
    grid-template-columns: 1fr;
  }
  .panel {
    padding: 1rem;
  }
}

/* Custom Styles */
(() => {
  const snapRoot = document.getElementById("snapRoot");

  // ----- Intro overlay -----
  const introOverlay = document.getElementById("introOverlay");
  const introVideo = document.getElementById("introVideo");

  function hideIntro() {
    if (!introOverlay) return;
    introOverlay.classList.add("hidden");
    window.setTimeout(() => introOverlay.remove(), 650);
  }

  // Autoplay is generally allowed only if muted; we keep it muted. 
  if (introVideo) {
    introVideo.addEventListener("ended", hideIntro);
    introVideo.addEventListener("error", hideIntro);

    // If the video never loads, fail open after 2.5s
    window.setTimeout(() => {
      if (document.body.contains(introOverlay)) hideIntro();
    }, 2500);
  } else {
    hideIntro();
  }

  // ----- Music (single track) -----
  const bgMusic = document.getElementById("bgMusic");
  const musicToggle = document.getElementById("musicToggle");
  const musicVol = document.getElementById("musicVol");

  if (bgMusic && musicVol) {
    bgMusic.volume = Number(musicVol.value || 0.25);
    musicVol.addEventListener("input", () => {
      bgMusic.volume = Number(musicVol.value);
    });
  }

  async function toggleMusic() {
    if (!bgMusic || !musicToggle) return;

    if (bgMusic.paused) {
      try {
        await bgMusic.play();
        musicToggle.textContent = "Music: ON";
        musicToggle.setAttribute("aria-pressed", "true");
      } catch {
        // You requested the old autoplay-blocked toast be removed, so we stay silent here.
      }
    } else {
      bgMusic.pause();
      musicToggle.textContent = "Music: OFF";
      musicToggle.setAttribute("aria-pressed", "false");
    }
  }

  if (musicToggle) {
    musicToggle.addEventListener("click", toggleMusic);
  }

  // ----- Scroll snap backgrounds + arrows -----
  const sections = Array.from(document.querySelectorAll(".snapSection"));

  function setSectionBackgroundVars(section) {
    const bgA = section.getAttribute("data-bg");
    const bgB = section.getAttribute("data-bg2");

    section.style.setProperty("--bgA", bgA ? `url("${bgA}")` : "none");
    section.style.setProperty("--bgB", bgB ? `url("${bgB}")` : "none");
  }

  sections.forEach(setSectionBackgroundVars);

  // Use IntersectionObserver to:
  // 1) highlight nav
  // 2) trigger bg swap (Experience: AirForce_Emblem.png -> CADdets_1.png while staying in same section)
  const navLinks = Array.from(document.querySelectorAll(".sectionNav__link"));

  function setActiveNav(id) {
    navLinks.forEach(a => a.classList.toggle("active", a.getAttribute("href") === `#${id}`));
  }

  const io = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (!entry.isIntersecting) return;

      const section = entry.target;
      const id = section.id;
      setActiveNav(id);

      // background swap behavior when entering a section that has bg2
      const hasBg2 = Boolean(section.getAttribute("data-bg2"));
      section.classList.remove("swapBg");
      if (hasBg2) {
        window.setTimeout(() => {
          // still in DOM and likely still in view
          section.classList.add("swapBg");
        }, 650);
      }
    });
  }, { root: snapRoot, threshold: 0.6 });

  sections.forEach(s => io.observe(s));

  // Scroll cue + arrows: go to next section
  function scrollToNext(fromSection) {
    const nextSel = fromSection.getAttribute("data-next");
    if (!nextSel) return;
    const next = document.querySelector(nextSel);
    if (!next) return;
    next.scrollIntoView({ behavior: "smooth", block: "start" });
  }

  // Click handlers for cue/arrow
  document.querySelectorAll("[data-scroll-next]").forEach(el => {
    const section = el.closest(".snapSection");
    if (!section) return;

    el.addEventListener("click", () => scrollToNext(section));
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        scrollToNext(section);
      }
    });
  });

  // Also: make arrow-only elements work
  document.querySelectorAll(".scrollArrowOnly").forEach(el => {
    const section = el.closest(".snapSection");
    if (!section) return;

    el.addEventListener("click", () => scrollToNext(section));
    el.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        scrollToNext(section);
      }
    });
  });

  // ----- Hidden Screensaver Sequence -----
  const eggBtn = document.getElementById("easterEgg");
  const modal = document.getElementById("screensaverModal");
  const ssVideo = document.getElementById("ssVideo");
  const ssAudio = document.getElementById("ssAudio");

  const CLOSE_SELECTORS = "[data-close]";
  function qsAll(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }

  function openModal() {
    if (!modal) return;
    modal.classList.add("open");
    modal.setAttribute("aria-hidden", "false");
    document.body.style.overflow = "hidden";
  }

  function closeModal() {
    if (!modal) return;
    modal.classList.remove("open");
    modal.setAttribute("aria-hidden", "true");
    document.body.style.overflow = "hidden"; // body already hidden; snapRoot scrolls
    stopScreensaver();
  }

  if (modal) {
    qsAll(CLOSE_SELECTORS, modal).forEach(el => el.addEventListener("click", closeModal));
    window.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && modal.classList.contains("open")) closeModal();
    });
  }

  // Fade helpers
  function clamp01(x) { return Math.max(0, Math.min(1, x)); }

  function fadeOpacity(el, from, to, ms) {
    return new Promise(resolve => {
      const start = performance.now();
      function tick(now) {
        const t = clamp01((now - start) / ms);
        const v = from + (to - from) * t;
        el.style.opacity = String(v);
        if (t >= 1) resolve();
        else requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  function fadeAudio(audio, from, to, ms) {
    return new Promise(resolve => {
      const start = performance.now();
      function tick(now) {
        const t = clamp01((now - start) / ms);
        const v = from + (to - from) * t;
        audio.volume = clamp01(v);
        if (t >= 1) resolve();
        else requestAnimationFrame(tick);
      }
      requestAnimationFrame(tick);
    });
  }

  let screensaverRunning = false;

  async function playStep({ videoSrc, audioSrc, fadeInMs, fadeOutMs, audioLeadMs = 0, videoFadeInDelayMs = 0 }) {
    if (!ssVideo || !ssAudio) return;

    // Load sources
    ssVideo.src = videoSrc;
    ssVideo.load();

    ssAudio.src = audioSrc;
    ssAudio.load();

    ssVideo.style.opacity = "0";
    ssAudio.volume = 0;

    // Start audio first if requested (3rd iteration: hear audio before video appears)
    await ssAudio.play().catch(() => {});
    if (audioLeadMs > 0) {
      await fadeAudio(ssAudio, 0, 0.85, Math.min(650, fadeInMs));
      await new Promise(r => setTimeout(r, audioLeadMs));
    }

    // Start video
    await ssVideo.play().catch(() => {});
    if (videoFadeInDelayMs > 0) await new Promise(r => setTimeout(r, videoFadeInDelayMs));

    // Fade in visuals + audio (if audio not already led in)
    if (audioLeadMs === 0) {
      await Promise.all([
        fadeOpacity(ssVideo, 0, 1, fadeInMs),
        fadeAudio(ssAudio, 0, 0.85, fadeInMs),
      ]);
    } else {
      await fadeOpacity(ssVideo, 0, 1, fadeInMs);
    }

    // Wait until near the end of the video, then fade out
    const safetyMs = 250;
    const durationMs = isFinite(ssVideo.duration) ? (ssVideo.duration * 1000) : 8000;
    const waitMs = Math.max(0, durationMs - fadeOutMs - safetyMs);
    await new Promise(r => setTimeout(r, waitMs));

    await Promise.all([
      fadeOpacity(ssVideo, 1, 0, fadeOutMs),
      fadeAudio(ssAudio, ssAudio.volume, 0, fadeOutMs),
    ]);

    ssVideo.pause();
    ssAudio.pause();
  }

  async function runScreensaverSequence() {
    if (screensaverRunning) return;
    screensaverRunning = true;

    openModal();

    // Step 1: Screensaver_1.mp4 + Travel_through_space.mp3 then fade out quick
    await playStep({
      videoSrc: "assets/screensavers/Screensaver_1.mp4",
      audioSrc: "assets/screensavers/Travel_through_space.mp3",
      fadeInMs: 450,
      fadeOutMs: 450,
    });
    if (!screensaverRunning) return;

    // Step 2: quick fade in video+audio for Screensaver_2 + Blender_Hyperspace_Jump
    await playStep({
      videoSrc: "assets/screensavers/Screensaver_2.mp4",
      audioSrc: "assets/screensavers/Blender_Hyperspace_Jump.mp3",
      fadeInMs: 450,
      fadeOutMs: 450,
    });
    if (!screensaverRunning) return;

    // Step 3: 5s fade in video; fast fade in audio; audio heard before beach is seen
    await playStep({
      videoSrc: "assets/screensavers/Screensaver_3.mp4",
      audioSrc: "assets/screensavers/Alien_Beach_Waves.mp3",
      fadeInMs: 5000,              // slow video fade-in
      fadeOutMs: 650,
      audioLeadMs: 700,            // audio begins before video is visible
      videoFadeInDelayMs: 0
    });

    // Done
    closeModal();
  }

  function stopScreensaver() {
    screensaverRunning = false;
    if (ssVideo) {
      ssVideo.pause();
      ssVideo.removeAttribute("src");
      ssVideo.load();
      ssVideo.style.opacity = "0";
    }
    if (ssAudio) {
      ssAudio.pause();
      ssAudio.removeAttribute("src");
      ssAudio.load();
      ssAudio.volume = 0;
    }
  }

  if (eggBtn) {
    eggBtn.addEventListener("click", runScreensaverSequence);
  }

})();
